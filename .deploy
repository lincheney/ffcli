#!/usr/bin/env bash

set -eu -o pipefail

b64() {
    base64 -w0 | tr -d = | tr + - | tr / _
}

addon_curl() {
    header="$(jq -nc '{alg: "HS256", typ: "JWT"}' | b64)"
    payload="$(jq -nc '{
        "iss": env.AMO_ISSUER,
        "jti": now,
        "iat": now,
        "exp": (now + 60),
    }' | b64)"
    signature="$(<<<"$header.$payload" tr -d \\n | sha256hmac --key "$AMO_SECRET" | cut -d' ' -f1 | xxd -r -p | b64)"
    jwt="$header.$payload.$signature"
    if ! stdout="$(curl -L --fail-with-body --silent --show-error -H "Authorization: JWT $jwt" "$@")"; then
        echo "$stdout" >&2
        return 1
    fi
    printf %s "$stdout"
}

version="$(unzip -p /tmp/ffcli.zip manifest.json | jq -re .version)"
if ! details="$(addon_curl "https://addons.mozilla.org/api/v5/addons/addon/$addon/versions/$version/")"; then

    upload="$(addon_curl https://addons.mozilla.org/api/v5/addons/upload/ -XPOST -F "upload=@$file" -F channel=unlisted | jq -re .uuid)"
    while true; do
        details="$(addon_curl "https://addons.mozilla.org/api/v5/addons/upload/$upload/" -H 'Content-Type: application/json')"
        if <<<"$details" jq -re .processed >/dev/null; then
            if ! <<<"$details" jq -re .valid >/dev/null; then
                echo "addon invalid" >&2
                exit 1
            fi
            break
        fi
        sleep 10
    done

    data="$(jq -nc --arg upload "$upload" '{upload: $upload}')"
    version="$(addon_curl "https://addons.mozilla.org/api/v5/addons/addon/$addon/versions/" -H 'Content-Type: application/json' -d "$data" | jq -re .version)"

    while true; do
        details="$(addon_curl "https://addons.mozilla.org/api/v5/addons/addon/$addon/versions/$version/")"
        status="$(<<<"$details" jq -re .file.status)"
        if [[ "$status" == disabled ]]; then
            echo "review failed" >&2
            exit 1
        elif [[ "$status" == public ]]; then
            break
        fi
        sleep 10
    done

fi

url="$(<<<"$details" jq -re .file.url)"
addon_curl "$url" --output "$1"
